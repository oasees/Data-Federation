


# Oasees Gaia-x dataproduct on boarding

This document is a user manual and explains what is necessary to use the API developed in Datamite using Gaia-X services.


## 1.- Prerequisites

To properly install and use the API, the following prerequisites must be met.

1.1 Create a valid X.509 certificate for a designated domain 
--------------
The API requires installation on a machine equipped with DNS and a valid X.509 certificate. The first step is to determine the domain name assigned to the machine, after which a valid certificate must be generated for the specified domain.

A certificate from Let's Encrypt (Let's Encrypt) can be used; however, it will only be valid for the "development" branch of the "Gaia-X Lab" Gaia-X Clearing House (Gaia-X Clearing House). Consequently, the API will operate exclusively with development branch service URLs. The certificate should be placed in the "oasees.env" environment file, which will be further explained in later sections.

 ![Descripción](./images/image1.png)


A certificate generated by Let's Encrypt (Let's Encrypt) can be used, but it will only be valid for the "development" branch of the "Gaia-X Lab" Gaia-X Clearing House (Gaia-X Clearing House). 
As a result, the API will exclusively utilize service URLs associated with the development branch. 

 ![Descripción](./images/Ch.png)

It is necessary to have a valid certificate from the Trust Anchors (https://gaia-x.gitlab.io/policy-rules-committee/trust-framework/trust_anchors/), such as:

(Here, you can list the specific certificates required.)

 ![Descripción](./images/ta.png)

A machine with external access, DNS, and a configured X.509 certificate is required. It is mandatory to install a web server such as Apache2 and ensure that the URL https://DOMAIN/.well-known/ is resolvable. The installation process and some configuration details will be covered in the next section, Installation. All JSON-LD self-descriptors that are created will be placed behind the previously mentioned URL.

1.2 A machine with external access, a configured DNS, and an X.509 certificate.
--------------

A machine with external access, DNS, and a configured X.509 certificate is required. It is mandatory to install a web server such as Apache2 and ensure that the URL https://DOMAIN/.well-known/ is resolvable. The installation process and some configuration details will be covered in the next section, Installation. All JSON-LD self-descriptors that are created will be placed behind the previously mentioned URL.

 ![Descripción](./images/server.png)

1.3 Ports
--------------

- Port 443: Required for the Apache Web Server. The generated JSON files must have a resolvable URL, such as https://DOMAIN/.well-known/participant.json.

- Port 9102: Needed for the API. If external access is required, this port must be opened.

## 2.- Generate a Let's Encrypt certificate.
To generate the certificate, the first step is to ensure that specific firewall ports are open. At a minimum, ports 80 (HTTP) and 443 (HTTPS) must be accessible. Additionally, if using Certbot (the Let's Encrypt client that obtains and deploys certificates on a web server), traffic to U.S. servers should be allowed.

Once the necessary ports are open, the certificate creation process can begin. The initial step involves installing Certbot on the virtual machine. There are multiple installation methods, one of which is via snap:

```
sudo snap install --classic certbot
```

After installation, generate the certificate using the following command:

```
sudo certbot certonly --standalone -d DOMAIN
```

This process will create the following files in the directory: /etc/letsencrypt/live/DOMAIN/

 - fullchain.pem
 - privkey.pem
 - cert.pem
 - chain.pem

## 3.- Generate a complete certificate chain

A complete certificate chain, from root to leaf, is required. The Let's Encrypt-generated certificate (fullchain.pem) does not fulfill this requirement, so it is necessary to use the utility provided at What's My Chain Cert.

To proceed, select the appropriate option shown in the figure, enable the "Include Root Certificate" setting, and then click "Generate Chain".

 ![Descripción](./images/whatmychaincert.png)

The process generates a file with the .crt extension. Be sure to save it, as it will be required in the upcoming steps.



 ## 4.- Download the code 

```
git clone https://github.com/oasees/Data-Federation.git
cd Dataproduct
```
The installation has been carried out using a Docker Compose file, which includes multiple services:

 - Gaia-X Onboarding API – An API for generating GAIA-X compliant JSON-LD files, such as did.json, participant self-descriptors, and data product self-descriptors.
 - Apache Web Server – Installation and configuration of the web server.
 - Neo4j Graph Database – Used to store generated data products.
 - PostgreSQL Relational Database

All generated JSON-LD files are stored on the Apache2 web server.

Only Gaia-X compliant data products are saved in the Neo4j graph database. This allows metadata to be provided for various data products, enabling the EDC provider to consider including them as assets in its inventory.

Once a data product meets compliance requirements, it is registered as a new entry in the CES Registry. This registration is performed by calling the Credential Event Service URL, and the resulting output URL from the registry is stored in the PostgreSQL database.

4.1 Apache Docker 
--------------
 ![Descripción](./images/apacheDir.png)

### 4.1.1 apacheDir directory
Verify the value of $HOME and create an "apacheDir" directory within it.

Copy the .crt file generated in the "Create a Whole Chain for the Certificate" section into the /DIRECTORY/apacheDir directory.


### 4.1.2 Apache Docker directory

Navigate to the APACHE_DOCKER folder and locate the files corresponding to the full certificate chain and the private key.

If the certificate is issued by Let's Encrypt, the certificate files are typically found in the /etc/letsencrypt/live/DOMAIN/ directory. Copy the fullchain.pem and privkey.pem files into the APACHE_DOCKER directory.


### 4.1.3 Modify “000-default.conf” file


Change “Redirect” value for the correct one domain.

### 4.1.4 Update the default-ssl.conf File
Modify the "default-ssl.conf" configuration file, ensuring that the SSLCertificateFile and SSLCertificateKeyFile directives are only adjusted if the names of fullchain.pem and privkey.pem have been changed.

 ![Descripción](./images/apache.png)

IMPORTANT!

If the names of these files are modified, you must update the "Dockerfile" located inside the "APACHE_DOCKER" directory. Ensure that the new names for the two .pem files are correctly specified in the configuration.



4.2 Neo4j 
--------------
Verify the value of $HOME and create an "neo4j" directory within it.


4.3 oasees.env file 
--------------
In this file, the following variables need to be modified:

- NOTARIZATION_API
- COMPLIANCE_API
- CREDENTIALS_EVENT_SERVICE_API
- CERTIFICATE_URL
- PRIVATE_KEY

Ensure that each variable is updated accordingly based on your configuration requirements.
The assigned values for the first three variables are:

- NOTARIZATION_API → https://registrationnumber.notary.lab.gaia-x.eu/development/registration-numbers/
- COMPLIANCE_API → https://compliance.lab.gaia-x.eu/development/api/credential-offers
- CREDENTIALS_EVENT_SERVICE_API → https://ces-development.lab.gaia-x.eu/credentials-events

- CERTIFICATE_URL -> This certificate is generated through What's My Chain Cert and may have a .crt file extension. It must be stored in /DIRECTORY/apacheDir.

  CERTIFICATE_URL=https://DOMAIN/.well-known/certificate.pem

- PRIVATE_KEY The private key for the certificate is also placed in the "oasees.env" environment file in the following format:
 ```
PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCiQU6f0fVkZWmO
…….
fOssCXwbAgMBAAECggEAMNpyBmvss2xXcmZX3bvVjD05YPleWuY6eCIWMVYWRBYl
oaM3qfBpOaTtGqcFJn3Hc649i+G04B+xIGBqSKBkKArQtSs5zUyKnHLsJqtDqC1F
RoEnkJmWC7BV15CFdyBtng==
-----END PRIVATE KEY-----"

```
Once all necessary modifications have been made in the "Apache docker" folder and "oasees.env" file, execute the following command:
 ````
 docker-compose up -d -> if you don’t want to see the logs
docker-compose up -> if you want to see the logs. 
 
 ````